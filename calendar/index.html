<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <link rel="stylesheet" type="text/css" href="http://visapi-gadgets.googlecode.com/svn/trunk/pilesofmoney/pom.css"/>
    <script type="text/javascript" src="http://visapi-gadgets.googlecode.com/svn/trunk/pilesofmoney/pom.js"></script>
    <style>
        #main {
          margin: 0;
          height: 100%;
          width: 100%;
          left: 0;
          top: 0;
          position: absolute;
          overflow-x: auto;
          overflow-y: auto;
        }
        svg {
          width: 920px;
        }
    </style>
</head>

<body>
<script src="/_global_/customview/v1/omniscope.js"></script>

<div id="main"></div>

<script>
  
    if (!omniscope || !omniscope.view) throw new Error("Omniscope chart API is not loaded");
    
    google.load("visualization", "1.1", {packages:["calendar"]});

    if (!omniscope || !omniscope.view) throw new Error("Omniscope chart API is not loaded");
    omniscope.view.on("load", function() {
        window.onerror = function(msg) {
            omniscope.view.error(msg);
        }
    });

    // Ensure clicks on unoccupied space clear the selection in Omniscope, and close menus:
    document.body.addEventListener("click", function() {
        omniscope.view.whitespaceClick();
    });

    // Naively redraw on any of these events 
    // (load = first init, update = external settings/state change, resize = browser window resized)
    omniscope.view.on(["load", "update", "resize"], function() {
        // Retrieve the auto-query results, a 2d array ([row][column]):
        renderView(omniscope.view.context().result);
    });
  
    var renderView = function (result) {
      
      // Retrieve the auto-query results, a 2d array ([row][column]):
      var records = result.data.records;
      var mappings = result.mappings;
           
      // Map records to field options
      var data = [];
      records.forEach(function(record) {
        data.push({
          date: (mappings.date !== undefined) ? record[mappings.date] : null,
          value: (mappings.value !== undefined) ? record[mappings.value] : null
        });
      });
      
      var rowData = result.data.records;

      var totalYears = [];
      
      var dataTable = new google.visualization.DataTable();
      dataTable.addColumn({ type: 'date', id: 'Date' });
      dataTable.addColumn({ type: 'number', id: 'DataItem'});
      
      for (var i=0; i < data.length; i++) {
        var row = data[i];
        var date = new Date(row.date);
        var year = date.getYear();
            
        if (totalYears.indexOf(year)<0) {
          totalYears.push(year);
        }
        dataTable.addRows([        
          [ date, row.value ]
        ]);
      }
       
      var charts = document.getElementById('main');
      var chart = new google.visualization.Calendar(document.getElementById('main'));

      var options = {
        height:  1+ totalYears.length *150
      };

      chart.draw(dataTable, options);

      google.visualization.events.addListener(chart, 'select', function() {
        var selectionArr = chart.getSelection();
        if (!selectionArr) return;
        
        var filter = {};
        filter.type = "AND";
        filter.filters = [];
        
        if (selectionArr[0]) {
            var dateValue = new Date(selectionArr[0].date).toISOString();
            var dateField = omniscope.view.context().options.items.date.inputField;
            filter.filters = [
              {"type": "FIELD_VALUE", "inputField": dateField, "value": dateValue, "operator": "="}
            ];
        }
        omniscope.view.context().viewSelection = filter;
        omniscope.view.updated();
      });
     
    };

</script>
</body>
</html>